<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Abertura de Sinistro - Sinistros GB</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- Favicon -->
  <link rel="icon" href="https://github.com/sinistrosgb-spec/sinistros-gb/blob/main/Meraki.ico?raw=true" type="image/x-icon">

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f0f0f0;
      color: #333;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: 40px auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
      border-top: 5px solid #003366;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .header img {
      height: 60px;
    }
    .title-container {
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: center;
    }
    .title-container img {
      height: 32px;
    }
    h1 {
      color: #003366;
      margin: 0;
    }
    .form-group {
      margin-bottom: 18px;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: #003366;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
    }
    .checkbox-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 6px;
      background: #f9f9f9;
    }
    .checkbox-grid label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    button {
      background: #003366;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin-right: 10px;
    }
    button:hover { background: #002244; }
    .alert {
      padding: 12px;
      margin: 15px 0;
      border-radius: 6px;
      display: none;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .footer-credit {
      text-align: center;
      margin-top: 30px;
      font-size: 12px;
      color: #aaa;
      border-top: 1px solid #ddd;
      padding-top: 10px;
    }
    /* Tela de login */
    .login-screen {
      text-align: center;
      padding: 40px;
    }
    .login-form {
      max-width: 400px;
      margin: 0 auto;
      background: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
    }
    .login-form input {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <!-- Tela de login -->
  <div id="loginScreen" class="login-screen">
    <div class="header">
      <img src="https://github.com/sinistrosgb-spec/sinistros-gb/blob/main/logo-claro.png?raw=true" alt="Claro" style="height:60px;">
      <img src="https://github.com/sinistrosgb-spec/sinistros-gb/blob/main/logo-boticario.png?raw=true" alt="Botic√°rio" style="height:40px;">
    </div>
    <h2>üîê Acesso ao Sistema de Sinistros</h2>
    <div class="login-form">
      <input type="email" id="email" placeholder="Seu e-mail corporativo" style="width:100%; padding:10px; margin-bottom:10px;">
      <input type="password" id="password" placeholder="Sua senha" style="width:100%; padding:10px; margin-bottom:10px;">
      <button onclick="login()">Entrar</button> <br>
      <a href="#" onclick="esqueciSenha(); return false;" style="font-size:12px; color:#003366;">Esqueci a senha</a>
    </div>
    <p style="font-size:12px; color:#888; margin-top:20px;">Apenas usu√°rios autorizados</p>
  </div>

  <!-- Formul√°rio (escondido at√© login) -->
  <div id="mainForm" style="display:none;">
    <div class="container">
      <div class="header">
        <img src="https://github.com/sinistrosgb-spec/sinistros-gb/blob/main/logo-claro.png?raw=true" alt="Claro" style="height:60px;">
        <div class="title-container">
          <img src="https://github.com/sinistrosgb-spec/sinistros-gb/blob/main/Meraki.ico?raw=true" alt="√çcone Meraki">
          <h1>üìù Abertura de Sinistro</h1>
        </div>
        <img src="https://github.com/sinistrosgb-spec/sinistros-gb/blob/main/logo-boticario.png?raw=true" alt="Grupo Botic√°rio" style="height:40px;">
      </div>

      <div id="status" class="alert"></div>

      <form id="sinistroForm">
        <div class="form-group">
          <label>Refer√™ncia *</label>
          <select id="registro" required>
            <option value="">Selecione...</option>
            <option value="TT Siebel">TT Siebel</option>
            <option value="OS BOTI">OS BOTI</option>
            <option value="INC">INC</option>
          </select>
        </div>

        <div class="form-group">
          <label>N√∫mero da Refer√™ncia *</label>
          <input type="text" id="numero_ocorrencia" required>
        </div>

        <div class="form-group">
          <label>Franquia *</label>
          <input type="text" id="franquia" required>
        </div>

        <div class="form-group">
          <label>Respons√°vel pela Franquia *</label>
          <input type="text" id="responsavel_franquia" required>
        </div>

        <div class="form-group">
          <label>Telefone do Respons√°vel</label>
          <input type="text" id="telefone_responsavel">
        </div>

        <div class="form-group">
          <label>E-mail do Respons√°vel *</label>
          <input type="email" id="email_responsavel" required>
        </div>

        <div class="form-group">
          <label>Data do Sinistro *</label>
          <input type="datetime-local" id="data_sinistro" required>
        </div>

        <div class="form-group">
          <label>Equipamentos Selecionados *</label>
          <div class="checkbox-grid" id="equipamentos-grid"></div>
          <input type="hidden" id="equipamentos_selecionados" required>
        </div>

        <div class="form-group">
          <label>Modelos dos Equipamentos *</label>
          <div class="checkbox-grid" id="modelos-grid"></div>
          <input type="hidden" id="modelos_equipamentos" required>
        </div>

        <div class="form-group">
          <label>Descri√ß√£o do Sinistro *</label>
          <textarea id="descricao" rows="4" required></textarea>
        </div>

        <div class="form-group">
          <label>Anexos (fotos, v√≠deos, PDFs)</label>
          <input type="file" id="anexos" multiple accept="image/*,video/*,application/pdf">
        </div>

        <button type="submit">üì§ Registrar Sinistro</button>
        <button type="button" onclick="logout()">Sair</button>
      </form>

      <div class="footer-credit">
        Desenvolvido por F√°bio Matos | Sistema Sinistros GB
      </div>
    </div>
  </div>

  <script>
    // üî• Supabase
    const supabaseUrl = 'https://zszgjhxyebhguyxguvek.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpzemdqaHh5ZWJoZ3V5eGd1dmVrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2Mjg4NDYsImV4cCI6MjA3MTIwNDg0Nn0.ac8jt3XRlhpNnwt4eJKwMN85K9IrG2i8y3EzRaEf1c8';
    const supabase = supabase.createClient(supabaseUrl, supabaseAnonKey);

    // Listas de op√ß√µes
    const equipamentos = [
      "SINISTRO TOTAL", "RACK", "NO-BREAK", "ESTABILIZADOR", "MX", "MR", "MS", "MV",
      "CABO DE ALIMENTA√á√ÉO", "FONTE POE", "MODEM 4G", "MODEM CISCO"
    ];
    const modelos = [
      "SMS STATION 2 1200", "APC 1200", "SMS PROGRESSIVE II", "MX64", "MX65", "MX68",
      "MR33", "MR36", "MS - 8 PORTAS S/ POE", "MS - 8 PORTAS C/ POE", "MS 24 PORTAS S/ POE",
      "MS 24 PORTAS C/ POE", "MV02", "MV12w", "CABO DE ALIMENTA√á√ÉO", "PoE",
      "ZTE - MF253", "ZTE - MF293", "ELSYS - EPRL12", "ELSYS - EPRL18", "CISCO 1905", "N√ÉO INFORMADO"
    ];

    // Detectar convite ou recupera√ß√£o de senha
    document.addEventListener('DOMContentLoaded', async () => {
      const hash = window.location.hash;

      if (hash.includes('access_token')) {
        const params = new URLSearchParams(hash.substring(1));
        const accessToken = params.get('access_token');
        const type = params.get('type');

        if (accessToken && type === 'invite') {
          const newPassword = prompt('Bem-vindo! Crie sua nova senha:');
          if (newPassword) {
            const { error } = await supabase.auth.updateUser({ password: newPassword });
            if (error) {
              alert('Erro ao criar senha: ' + error.message);
            } else {
              alert('Senha criada com sucesso! Fa√ßa login com sua senha.');
              window.location.hash = '';
              window.location.reload();
            }
          }
        }

        if (accessToken && type === 'recovery') {
          const newPassword = prompt('Digite sua nova senha:');
          if (newPassword) {
            const { error } = await supabase.auth.updateUser({ password: newPassword });
            if (error) {
              alert('Erro ao redefinir senha: ' + error.message);
            } else {
              alert('Senha redefinida com sucesso!');
              window.location.hash = '';
              window.location.reload();
            }
          }
        }
      }

      // Verificar sess√£o
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
        showForm();
      } else {
        showLogin();
      }
    });

    // Fun√ß√µes de login
    async function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      const { error, data } = await supabase.auth.signInWithPassword({ email, password });

      if (error) {
        alert('Erro de login: ' + error.message);
      } else {
        showForm();
      }
    }

    async function esqueciSenha() {
      const email = prompt('Digite seu e-mail para redefinir a senha:');
      if (!email) return;

      const { error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: 'https://sinistrosgb-spec.github.io/sinistros-gb/'
      });

      if (error) {
        alert('Erro: ' + error.message);
      } else {
        alert('Enviamos um link de redefini√ß√£o para ' + email + '.\nVerifique seu e-mail.');
      }
    }

    function logout() {
      supabase.auth.signOut();
      showLogin();
    }

    function showLogin() {
      document.getElementById('loginScreen').style.display = 'block';
      document.getElementById('mainForm').style.display = 'none';
    }

    function showForm() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('mainForm').style.display = 'block';
      gerarCheckboxes(equipamentos, 'equipamentos-grid', 'equipamentos_selecionados');
      gerarCheckboxes(modelos, 'modelos-grid', 'modelos_equipamentos');
    }

    function gerarCheckboxes(lista, containerId, hiddenId) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      lista.forEach(item => {
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.align-items = 'center';
        label.style.gap = '8px';
        label.style.margin = '4px 0';
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.value = item;
        input.onchange = () => {
          const selecionados = Array.from(container.querySelectorAll('input:checked')).map(el => el.value);
          document.getElementById(hiddenId).value = selecionados.join(', ');
        };
        label.appendChild(input);
        label.appendChild(document.createTextNode(item));
        container.appendChild(label);
      });
    }

    // Envio do formul√°rio
    document.getElementById('sinistroForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      // Gerar CH no final
      const { data, error: countError } = await supabase
        .from('sinistros')
        .select('ch_sinistro', { count: 'exact' })
        .like('ch_sinistro', `CH${new Date().toISOString().slice(0,10).replace(/-/g,'')}`);
      
      const sequencia = (data?.length || 0) + 1;
      const ch = `CH${new Date().toISOString().slice(0,10).replace(/-/g,'')}${String(sequencia).padStart(3, '0')}`;

      // Coletar dados
      const formData = {
        ch_sinistro: ch,
        registro: document.getElementById('registro').value,
        numero_ocorrencia: document.getElementById('numero_ocorrencia').value,
        franquia: document.getElementById('franquia').value,
        responsavel_franquia: document.getElementById('responsavel_franquia').value,
        telefone_responsavel: document.getElementById('telefone_responsavel').value,
        email_responsavel: document.getElementById('email_responsavel').value,
        data_sinistro: document.getElementById('data_sinistro').value,
        equipamentos_selecionados: document.getElementById('equipamentos_selecionados').value,
        modelos_equipamentos: document.getElementById('modelos_equipamentos').value,
        descricao: document.getElementById('descricao').value,
        status: 'Sinistro Registrado'
      };

      // Upload de arquivos
      const files = document.getElementById('anexos').files;
      if (files.length > 0) {
        const file = files[0];
        const filePath = `public/${ch}/${file.name}`;
        const { error: uploadError } = await supabase
          .storage
          .from('anexos-sinistros')
          .upload(filePath, file, { upsert: true });

        if (uploadError) {
          mostrarStatus('Erro ao enviar anexo: ' + uploadError.message, 'error');
        } else {
          const { data } = supabase.storage.from('anexos-sinistros').getPublicUrl(filePath);
          formData.anexos = data.publicUrl;
        }
      }

      // Enviar para o banco
      const { error } = await supabase.from('sinistros').insert([formData]);
      if (error) {
        mostrarStatus('Erro: ' + error.message, 'error');
      } else {
        document.getElementById('sinistroForm').style.display = 'none';
        mostrarStatus(`
          <h2>‚úÖ Sinistro ${ch} registrado com sucesso!</h2>
          <p>O n√∫mero do seu sinistro √©: <strong>${ch}</strong></p>
          <p>Vamos analisar o quanto antes.</p>
          <button onclick="window.location.reload()">‚ûï Novo Sinistro</button>
        `, 'success');
      }
    });

    function mostrarStatus(mensagem, tipo) {
      const status = document.getElementById('status');
      status.innerHTML = mensagem;
      status.className = `alert ${tipo}`;
      status.style.display = 'block';
    }
  </script>
</body>
</html>
