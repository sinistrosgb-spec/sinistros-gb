<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Abertura de Sinistro - Sinistros GB</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- Favicon personalizado -->
  <link rel="icon" href="https://github.com/sinistrosgb-spec/sinistros-gb/blob/main/Meraki.ico?raw=true" type="image/x-icon">
  <link rel="shortcut icon" href="https://github.com/sinistrosgb-spec/sinistros-gb/blob/main/Meraki.ico?raw=true" type="image/x-icon">

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f0f0f0;
      color: #333;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: 40px auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
      border-top: 5px solid #003366;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .header img {
      height: 60px;
    }
    .title-container {
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: center;
    }
    .title-container img {
      height: 32px;
    }
    h1 {
      color: #003366;
      margin: 0;
    }
    .form-group {
      margin-bottom: 18px;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: #003366;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
    }
    .checkbox-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 10px;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 6px;
      background: #f9f9f9;
    }
    .checkbox-grid label {
      font-weight: normal;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    button {
      background: #003366;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin-right: 10px;
    }
    button:hover {
      background: #002244;
    }
    .alert {
      padding: 12px;
      margin: 15px 0;
      border-radius: 6px;
      display: none;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .footer-credit {
      text-align: center;
      margin-top: 30px;
      font-size: 12px;
      color: #aaa;
      border-top: 1px solid #ddd;
      padding-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Cabe√ßalho com logos -->
    <div class="header">
      <img src="https://github.com/sinistrosgb-spec/sinistros-gb/blob/main/logo-claro.png?raw=true" alt="Claro" style="height:60px;">
      <div class="title-container">
        <img src="https://github.com/sinistrosgb-spec/sinistros-gb/blob/main/Meraki.ico?raw=true" alt="√çcone Meraki">
        <h1>üìù Abertura de Sinistro</h1>
      </div>
      <img src="https://github.com/sinistrosgb-spec/sinistros-gb/blob/main/logo-boticario.png?raw=true" alt="Grupo Botic√°rio" style="height:40px;">
    </div>

    <div id="status" class="alert"></div>

    <form id="sinistroForm">
      <div class="form-group">
        <label>CH-Sinistro (gerado automaticamente)</label>
        <input type="text" id="ch_sinistro" readonly placeholder="Ser√° gerado ao carregar">
      </div>

      <div class="form-group">
        <label>Refer√™ncia *</label>
        <select id="registro" required>
          <option value="">Selecione...</option>
          <option value="TT Siebel">TT Siebel</option>
          <option value="OS BOTI">OS BOTI</option>
          <option value="INC">INC</option>
        </select>
      </div>

      <div class="form-group">
        <label>N√∫mero da Refer√™ncia *</label>
        <input type="text" id="numero_ocorrencia" required>
      </div>

      <div class="form-group">
        <label>Franquia *</label>
        <input type="text" id="franquia" required>
      </div>

      <div class="form-group">
        <label>Respons√°vel pela Franquia *</label>
        <input type="text" id="responsavel_franquia" required>
      </div>

      <div class="form-group">
        <label>Telefone do Respons√°vel</label>
        <input type="text" id="telefone_responsavel">
      </div>

      <div class="form-group">
        <label>E-mail do Respons√°vel *</label>
        <input type="email" id="email_responsavel" required placeholder="E-mail de contato da franquia">
      </div>

      <div class="form-group">
        <label>Data do Sinistro *</label>
        <input type="datetime-local" id="data_sinistro" required>
      </div>

      <div class="form-group">
        <label>Equipamentos Selecionados *</label>
        <div class="checkbox-grid" id="equipamentos-grid"></div>
        <input type="hidden" id="equipamentos_selecionados" required>
      </div>

      <div class="form-group">
        <label>Modelos dos Equipamentos *</label>
        <div class="checkbox-grid" id="modelos-grid"></div>
        <input type="hidden" id="modelos_equipamentos" required>
      </div>

      <div class="form-group">
        <label>Descri√ß√£o do Sinistro *</label>
        <textarea id="descricao" rows="4" required></textarea>
      </div>

      <div class="form-group">
        <label>Anexos (fotos, v√≠deos, PDFs)</label>
        <input type="file" id="anexos" multiple accept="image/*,video/*,application/pdf">
      </div>

      <button type="submit">üì§ Registrar Sinistro</button>
      <button type="button" onclick="limparForm()">üîÑ Limpar</button>
    </form>

    <!-- Cr√©dito do desenvolvedor -->
    <div class="footer-credit">
      Desenvolvido por F√°bio Matos | Sistema Sinistros GB
    </div>
  </div>

  <script>
    // üî• Substitua com suas credenciais do Supabase
    const supabaseUrl = 'https://zszgjhxyebhguyxguvek.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpzemdqaHh5ZWJoZ3V5eGd1dmVrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2Mjg4NDYsImV4cCI6MjA3MTIwNDg0Nn0.ac8jt3XRlhpNnwt4eJKwMN85K9IrG2i8y3EzRaEf1c8';
    const supabase = supabase.createClient(supabaseUrl, supabaseAnonKey);

    // Listas de op√ß√µes
    const equipamentos = [
      "SINISTRO TOTAL", "RACK", "NO-BREAK", "ESTABILIZADOR", "MX", "MR", "MS", "MV",
      "CABO DE ALIMENTA√á√ÉO", "FONTE POE", "MODEM 4G", "MODEM CISCO"
    ];

    const modelos = [
      "SMS STATION 2 1200", "APC 1200", "SMS PROGRESSIVE II", "MX64", "MX65", "MX68",
      "MR33", "MR36", "MS - 8 PORTAS S/ POE", "MS - 8 PORTAS C/ POE", "MS 24 PORTAS S/ POE",
      "MS 24 PORTAS C/ POE", "MV02", "MV12w", "CABO DE ALIMENTA√á√ÉO", "PoE",
      "ZTE - MF253", "ZTE - MF293", "ELSYS - EPRL12", "ELSYS - EPRL18", "CISCO 1905", "N√ÉO INFORMADO"
    ];

    // Fun√ß√£o para gerar checkboxes
    function gerarCheckboxes(lista, containerId, hiddenId) {
      const container = document.getElementById(containerId);
      if (!container) {
        console.error(`Container ${containerId} n√£o encontrado`);
        return;
      }
      container.innerHTML = '';
      lista.forEach(item => {
        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '8px';
        label.style.margin = '4px 0';
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.value = item;
        input.onchange = () => {
          const selecionados = Array.from(container.querySelectorAll('input:checked')).map(el => el.value);
          document.getElementById(hiddenId).value = selecionados.join(', ');
        };
        label.appendChild(input);
        label.appendChild(document.createTextNode(item));
        container.appendChild(label);
      });
    }

    // Quando a p√°gina carregar
    document.addEventListener('DOMContentLoaded', async () => {
      // Gerar CH-Sinistro
      const { data, error } = await supabase
        .from('sinistros')
        .select('ch_sinistro', { count: 'exact' })
        .like('ch_sinistro', `CH${new Date().toISOString().slice(0,10).replace(/-/g,'')}`);
      
      const sequencia = (data?.length || 0) + 1;
      const ch = `CH${new Date().toISOString().slice(0,10).replace(/-/g,'')}${String(sequencia).padStart(3, '0')}`;
      document.getElementById('ch_sinistro').value = ch;

      // Gerar checkboxes
      gerarCheckboxes(equipamentos, 'equipamentos-grid', 'equipamentos_selecionados');
      gerarCheckboxes(modelos, 'modelos-grid', 'modelos_equipamentos');
    });

    // Limpar formul√°rio
    async function limparForm() {
      document.getElementById('sinistroForm').reset();
      const { data } = await supabase
        .from('sinistros')
        .select('ch_sinistro', { count: 'exact' })
        .like('ch_sinistro', `CH${new Date().toISOString().slice(0,10).replace(/-/g,'')}`);
      const sequencia = (data?.length || 0) + 1;
      const ch = `CH${new Date().toISOString().slice(0,10).replace(/-/g,'')}${String(sequencia).padStart(3, '0')}`;
      document.getElementById('ch_sinistro').value = ch;

      // Recriar checkboxes
      gerarCheckboxes(equipamentos, 'equipamentos-grid', 'equipamentos_selecionados');
      gerarCheckboxes(modelos, 'modelos-grid', 'modelos_equipamentos');
    }

    // Enviar formul√°rio
    document.getElementById('sinistroForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      // Coletar dados
      const formData = {
        ch_sinistro: document.getElementById('ch_sinistro').value,
        registro: document.getElementById('registro').value,
        numero_ocorrencia: document.getElementById('numero_ocorrencia').value,
        franquia: document.getElementById('franquia').value,
        responsavel_franquia: document.getElementById('responsavel_franquia').value,
        telefone_responsavel: document.getElementById('telefone_responsavel').value,
        email_responsavel: document.getElementById('email_responsavel').value,
        data_sinistro: document.getElementById('data_sinistro').value,
        equipamentos_selecionados: document.getElementById('equipamentos_selecionados').value,
        modelos_equipamentos: document.getElementById('modelos_equipamentos').value,
        descricao: document.getElementById('descricao').value,
        status: 'Sinistro Registrado'
      };

      // Upload de arquivos
      const files = document.getElementById('anexos').files;
      if (files.length > 0) {
        const file = files[0];
        const filePath = `public/${formData.ch_sinistro}/${file.name}`;
        const { error: uploadError } = await supabase
          .storage
          .from('anexos-sinistros')
          .upload(filePath, file, { upsert: true });

        if (uploadError) {
          mostrarStatus('Erro ao enviar anexo: ' + uploadError.message, 'error');
        } else {
          const { data } = supabase
            .storage
            .from('anexos-sinistros')
            .getPublicUrl(filePath);
          formData.anexos = data.publicUrl;
        }
      }

      // Enviar para o banco
      const { error } = await supabase.from('sinistros').insert([formData]);
      if (error) {
        mostrarStatus('Erro: ' + error.message, 'error');
      } else {
        // Tela de sucesso
        document.getElementById('sinistroForm').style.display = 'none';
        mostrarStatus(`
          <h2>‚úÖ Sinistro ${formData.ch_sinistro} registrado com sucesso!</h2>
          <p>Ol√°, seu sinistro foi registrado com sucesso. Vamos analisar o quanto antes.</p>
          <p><strong>N√∫mero do CH:</strong> ${formData.ch_sinistro}</p>
          <p>Um e-mail de confirma√ß√£o foi enviado para <strong>${formData.email_responsavel}</strong>.</p>
          <button onclick="window.location.reload()" style="background:#003366; color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer;">‚ûï Registrar novo sinistro</button>
        `, 'success');
      }
    });

    function mostrarStatus(mensagem, tipo) {
      const status = document.getElementById('status');
      status.innerHTML = mensagem;
      status.className = `alert ${tipo}`;
      status.style.display = 'block';
    }
  </script>
</body>
</html>
